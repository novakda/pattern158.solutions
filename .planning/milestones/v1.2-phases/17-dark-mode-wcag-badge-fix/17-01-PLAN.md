---
phase: 17-dark-mode-wcag-badge-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - css/main.css
autonomous: true
requirements: [A11Y-02]
gap_closure: true

must_haves:
  truths:
    - "All 23 dark mode pages pass WCAG 2.1 AA via axe-core (0 violations each)"
    - "Full test suite achieves 129/129 pass rate (was 115/129)"
    - "Badge and label text is readable on colored backgrounds in dark mode"
    - "No light mode regressions (21/21 pages still pass)"
  artifacts:
    - path: "css/main.css"
      provides: "Dark mode overrides for all badge/label elements on colored backgrounds"
      contains: "data-theme.*dark.*color.*on-primary\\|on-accent\\|background"
  key_links:
    - from: "css/main.css"
      to: "tests/accessibility.spec.mjs"
      via: "axe-core WCAG AA dark mode tests"
      pattern: "WCAG.*Dark Mode"
---

<objective>
Fix all remaining dark mode WCAG AA contrast failures by adding CSS dark mode overrides for badge/label elements on colored backgrounds. Currently 14/21 dark mode pages fail axe-core tests.

Purpose: Close the A11Y-02 gap — the only remaining partial requirement in v1.2 milestone. Brings dark mode from 33% to 100% WCAG AA compliance.

Output: Updated css/main.css with comprehensive dark mode badge/label contrast fixes. Full 129/129 test pass rate.
</objective>

<execution_context>
@/home/xhiris/.claude/get-shit-done/workflows/execute-plan.md
@/home/xhiris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-comprehensive-accessibility-qa/15-02-deferred-dark-mode-issues.md
@.planning/phases/15-comprehensive-accessibility-qa/15-02-SUMMARY.md
@.planning/phases/15-comprehensive-accessibility-qa/deferred-items.md
@css/main.css
@tests/accessibility.spec.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and fix all dark mode badge/label contrast violations</name>
  <files>css/main.css</files>
  <action>
Run the accessibility test suite in dark mode to get the current baseline of failures and identify exact failing elements:

```bash
npx playwright test tests/accessibility.spec.mjs --grep "Dark Mode" --reporter=list 2>&1 | head -80
```

Then run a targeted diagnostic to identify the specific axe-core violations on each failing page. Use a quick Playwright script or add temporary verbose output to identify failing elements by their CSS selectors.

**Root cause:** In dark mode, primary (#30c9dc) and accent (#d9b232) become bright colors. Elements using these as backgrounds need DARK text (--color-on-primary or --color-on-accent). Elements using --color-inverse as background need LIGHT text (--color-inverse-text) which should already work.

**Known patterns from 15-02 analysis — some already have dark mode overrides but more are needed:**

1. **`.impact-tag` (non-highlight)** — has `background: var(--color-inverse)` and `color: var(--color-inverse-text)`. In dark mode, --color-inverse is #1a2838 (same as page background), so these tags may be invisible or have contrast issues with surrounding elements. Check if axe detects this.

2. **`.impact-tag.highlight`** — has `background: var(--color-primary)` which becomes bright #30c9dc in dark mode. Already has dark mode override `color: var(--color-on-primary)` at line 202. Check if override is working or if there are additional nested elements.

3. **`.key-fact` on exhibit pages** — has `color: var(--color-heading)` which is #e8e8e8 in dark mode. When inside elements with colored backgrounds, this might fail contrast depending on exact background color.

4. **`.page-exhibit .key-fact`** inside `.impact-tag.highlight` — already has dark mode override at line 206, but `.key-fact` in OTHER contexts (inside `.report-section`, standalone) uses `--color-heading` which is fine on regular dark backgrounds.

5. **`.exhibit-label`** on testimonials page — uses `background: var(--color-inverse)` with `color: var(--color-inverse-text)`. The `.detail-exhibit .exhibit-label` variant uses `background: var(--color-accent)` and has dark mode override at line 218.

6. **Expertise badges** (`.badge-deep`, `.badge-working`, `.badge-aware`) — all have dark mode overrides at lines 214-228 but verify they are sufficient.

7. **`.finding-label`** — has `background: var(--color-primary)`, `color: var(--color-inverse-text)`. Dark mode override at line 198 changes to `--color-on-primary`. Scoped to `.page-index` only. Check if other pages have finding-labels that need the same override.

8. **Button text on primary backgrounds** (`.btn-primary`, `.copy-btn`, `.btn-social`) — already have dark mode overrides. Verify completeness.

9. **`.exhibit-link:hover`** and `.back-link:hover`** — hover states use `background: var(--color-primary)` with `color: var(--color-surface)`. In dark mode, surface is #2a3f54 on bright #30c9dc primary = may fail 4.5:1. Add dark mode override to use `--color-on-primary`.

**Fix approach — add dark mode overrides in the existing `DARK MODE: TEXT ON PRIMARY/ACCENT BACKGROUNDS` section (around lines 185-228):**

For each element type that has a colored background in dark mode, add a `[data-theme="dark"]` rule setting the text color to the appropriate contrast-safe token:
- Primary background (#30c9dc): use `--color-on-primary` (#0a1e2e, 7.83:1)
- Accent background (#d9b232): use `--color-on-accent` (#1a1400, 7.56:1)
- Text-muted background (#ababab): use `--color-background` (#1a2838) or `--color-on-primary`
- Inverse background (#1a2838): should already use --color-inverse-text, but verify

For `.impact-tag` (non-highlight) with `background: var(--color-inverse)`: In dark mode this background becomes the same as the page background (#1a2838). The text (--color-inverse-text = #faf9f6) should contrast fine. BUT if axe flags it, the issue might be that the tag blends into the page — consider adding a dark mode border or adjusting the background to --color-surface for visual distinction AND contrast.

For hover states that set `color: var(--color-surface)` on primary background, add:
```css
[data-theme="dark"] .page-testimonials .exhibit-link:hover,
[data-theme="dark"] .page-portfolio .exhibit-link:hover,
[data-theme="dark"] .page-exhibit .back-link:hover,
[data-theme="dark"] .page-exhibit-a .back-link:hover {
    color: var(--color-on-primary);
}
```

**IMPORTANT:** Run tests iteratively. After each batch of fixes, re-run `npx playwright test tests/accessibility.spec.mjs --grep "Dark Mode"` to check progress. Continue until all 21 dark mode tests pass.

**Do NOT change any light mode styles.** Only add/modify `[data-theme="dark"]` selectors.

**Do NOT modify test expectations.** The tests already assert zero violations — we need the CSS to pass them.
  </action>
  <verify>
Run full accessibility test suite:
```bash
npx playwright test tests/accessibility.spec.mjs --reporter=list
```
Expected: 129/129 tests pass (0 failures). Specifically:
- Light mode: 21/21 pass (no regression)
- Dark mode: 21/21 pass (was 7/21)
- Semantic: 84/84 pass
- ARIA: 3/3 pass
  </verify>
  <done>
All 23 pages pass WCAG 2.1 AA compliance in dark mode with zero axe-core violations. Full test suite achieves 129/129 pass rate. No light mode regressions introduced.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update REQUIREMENTS.md and verify A11Y-02 satisfied</name>
  <files>css/main.css</files>
  <action>
After Task 1 achieves 129/129 test pass rate:

1. Run the full test suite one final time across both browsers (Chromium + Firefox) to confirm cross-browser consistency:
```bash
npx playwright test tests/accessibility.spec.mjs
```
Expected: 258/258 total (129 per browser).

2. Verify no CSS regressions by spot-checking:
- Open index.html in browser, toggle dark mode, visually confirm badges/labels readable
- Check one exhibit page (exhibit-a.html) dark mode rendering
- Check technologies.html dark mode badge colors

3. Update `.planning/REQUIREMENTS.md`:
- Change A11Y-02 from `[ ]` to `[x]`
- Keep all other requirements unchanged

4. Document the specific CSS changes made in the SUMMARY file (created by execute-plan workflow).
  </action>
  <verify>
- `grep "A11Y-02" .planning/REQUIREMENTS.md` shows `[x]` status
- Full test suite passes on both Chromium and Firefox
- No visual regressions in dark mode
  </verify>
  <done>
A11Y-02 requirement marked as satisfied. Cross-browser test results confirm 258/258 pass rate. Dark mode WCAG AA compliance achieved across all 23 pages on Chromium and Firefox.
  </done>
</task>

</tasks>

<verification>
1. Run `npx playwright test tests/accessibility.spec.mjs --reporter=list` — all 129 tests pass
2. Run `npx playwright test tests/accessibility.spec.mjs` (multi-browser) — all 258 tests pass
3. Verify A11Y-02 is marked `[x]` in REQUIREMENTS.md
4. Verify no hardcoded color values added to CSS (only use design tokens)
5. Verify all new dark mode overrides use `[data-theme="dark"]` selector pattern
</verification>

<success_criteria>
- 129/129 accessibility tests pass (single browser)
- 258/258 accessibility tests pass (cross-browser: Chromium + Firefox)
- A11Y-02 requirement status changed from partial to satisfied
- Zero light mode regressions
- All CSS changes use existing design token system (no hardcoded hex values)
</success_criteria>

<output>
After completion, create `.planning/phases/17-dark-mode-wcag-badge-fix/17-01-SUMMARY.md`
</output>

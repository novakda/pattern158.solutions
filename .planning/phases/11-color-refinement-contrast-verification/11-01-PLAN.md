---
phase: 11-color-refinement-contrast-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - css/main.css
autonomous: true
requirements:
  - COLOR-01
  - COLOR-02

must_haves:
  truths:
    - "All text-on-background color pairs pass WCAG AA contrast (4.5:1 normal text, 3:1 large text/UI) in light mode"
    - "All text-on-background color pairs pass WCAG AA contrast (4.5:1 normal text, 3:1 large text/UI) in dark mode"
    - "Dark mode uses navy-based backgrounds (#1a2838 family), not generic black"
    - "Text-level color tokens serve distinct visual purposes or are consolidated"
    - "Gold accent (#b8860b) usage meets contrast requirements appropriate to its role (text vs decorative)"
    - "Teal primary (#0e7c8c) passes contrast on all background contexts in both modes"
  artifacts:
    - path: "css/main.css"
      provides: "Color tokens with verified WCAG AA compliance"
      contains: "--color-primary"
  key_links:
    - from: ":root color tokens"
      to: "[data-theme=dark] color tokens"
      via: "CSS custom property overrides"
      pattern: "data-theme.*dark"
---

<objective>
Audit all color token pairs for WCAG AA contrast compliance in both light and dark modes, fix any failures, evaluate text-level token consolidation, and verify dark mode brand consistency.

Purpose: Establish verified, accessible color foundation before link styling and visual verification in Plan 02.
Output: Updated css/main.css with all color tokens passing WCAG AA contrast in both themes.
</objective>

<execution_context>
@/home/xhiris/.claude/get-shit-done/workflows/execute-plan.md
@/home/xhiris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-color-refinement-contrast-verification/11-CONTEXT.md
@css/main.css (lines 1-150 — all color tokens in :root and [data-theme="dark"])
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit all color token pairs for WCAG AA contrast and fix failures</name>
  <files>css/main.css</files>
  <action>
  Systematically audit every text-on-background color combination defined in the token system for WCAG AA compliance. This is a mathematical audit — compute contrast ratios using the WCAG relative luminance formula.

  **Light mode pairs to audit (at minimum):**
  - --color-text (#2d3436) on --color-background (#faf9f6) → body text
  - --color-text (#2d3436) on --color-surface (#ffffff) → cards/panels
  - --color-text-muted (#666666) on --color-background (#faf9f6) → secondary text
  - --color-text-muted (#666666) on --color-surface (#ffffff) → secondary text on cards
  - --color-text-light (#999999) on --color-background (#faf9f6) → tertiary text
  - --color-text-light (#999999) on --color-surface (#ffffff) → tertiary text on cards
  - --color-text-medium (#555555) on --color-background (#faf9f6)
  - --color-text-source (#888888) on --color-background (#faf9f6) → source citations
  - --color-text-timeline (#444) on --color-background (#faf9f6) → timeline elements
  - --color-heading (#1a2838) on --color-background (#faf9f6) → headings
  - --color-heading (#1a2838) on --color-surface (#ffffff) → headings on cards
  - --color-primary (#0e7c8c) on --color-background (#faf9f6) → links/accents
  - --color-primary (#0e7c8c) on --color-surface (#ffffff) → links on cards
  - --color-accent (#b8860b) on --color-background (#faf9f6) → gold accent as text
  - --color-accent (#b8860b) on --color-surface (#ffffff) → gold accent on cards
  - --color-inverse-text (#faf9f6) on --color-inverse (#1a2838) → nav/hero/footer text
  - --color-inverse-text-muted (rgba 0.8) on --color-inverse (#1a2838) → muted text on dark sections
  - --color-inverse-text-light (rgba 0.7) on --color-inverse (#1a2838) → light text on dark sections
  - --color-primary (#0e7c8c) on --color-inverse (#1a2838) → teal on dark sections (nav hover)
  - --color-danger (#dc3545) on --color-background (#faf9f6) → error/danger text
  - --color-surface (#ffffff) text on --color-primary (#0e7c8c) → button text on teal bg

  **Dark mode pairs to audit (at minimum):**
  - --color-text (#e8e8e8) on --color-background (#1a2838)
  - --color-text (#e8e8e8) on --color-surface (#2a3f54)
  - --color-text-muted (#a0a0a0) on --color-background (#1a2838)
  - --color-text-muted (#a0a0a0) on --color-surface (#2a3f54)
  - --color-text-light (#888888) on --color-background (#1a2838)
  - --color-text-light (#888888) on --color-surface (#2a3f54)
  - --color-text-medium (#b0b0b0) on --color-background (#1a2838)
  - --color-text-source (#909090) on --color-background (#1a2838)
  - --color-text-timeline (#b0b0b0) on --color-background (#1a2838)
  - --color-heading (#e8e8e8) on --color-background (#1a2838)
  - --color-heading (#e8e8e8) on --color-surface (#2a3f54)
  - --color-primary (#0e7c8c) on --color-background (#1a2838) → teal on navy
  - --color-primary (#0e7c8c) on --color-surface (#2a3f54) → teal on surface
  - --color-accent (#b8860b) on --color-background (#1a2838) → gold on navy
  - --color-danger (#dc3545) on --color-background (#1a2838)
  - --color-border (#3d5266) — verify visible on --color-background (#1a2838)

  **For each failing pair:**
  1. Determine whether it's used as normal text (need 4.5:1) or large text/UI (need 3:1)
  2. Apply minimal color shift to achieve compliance while maintaining brand feel
  3. If near-pass (within 0.5 of threshold), nudge color slightly
  4. If far from pass, consider whether the token serves a real purpose or can be consolidated

  **Token consolidation evaluation:**
  Check whether all 5 text-level tokens (muted, light, medium, source, timeline) serve distinct visual purposes in the CSS. If any two produce effectively the same contrast ratio and are used interchangeably, consolidate by aliasing one to the other. Document which tokens were consolidated and why.

  **Gold accent audit:**
  Find all usages of --color-accent in the CSS. Classify each as: text, interactive element, or decorative. Apply 4.5:1 for text, 3:1 for interactive/large, no requirement for purely decorative.

  **Dark mode navy verification:**
  Confirm dark mode backgrounds (#1a2838, #243447, #2a3f54) are navy-based, not drifting toward generic gray or black. Adjust if needed to maintain the NTSB brand identity.

  **Teal primary check:**
  Verify --color-primary (#0e7c8c) passes 3:1 minimum on all dark background variants (#1a2838, #243447, #2a3f54). If it fails, shift lighter while maintaining teal identity. Update --color-primary-hover proportionally.

  Update all token values directly in css/main.css :root and [data-theme="dark"] blocks. Add a comment documenting the contrast ratios for the most critical pairs.
  </action>
  <verify>
  Write a quick Node.js script that computes WCAG contrast ratios for all critical pairs and outputs pass/fail for AA compliance. Run it and confirm all pairs pass:

  ```bash
  node -e "
  // WCAG relative luminance + contrast ratio calculator
  function luminance(hex) {
    const rgb = hex.replace('#','').match(/.{2}/g).map(h => {
      const v = parseInt(h, 16) / 255;
      return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
    });
    return 0.2126 * rgb[0] + 0.7152 * rgb[1] + 0.0722 * rgb[2];
  }
  function contrast(fg, bg) {
    const l1 = Math.max(luminance(fg), luminance(bg));
    const l2 = Math.min(luminance(fg), luminance(bg));
    return (l1 + 0.05) / (l2 + 0.05);
  }
  // Test critical pairs...
  const pairs = [
    ['#2d3436', '#faf9f6', 'text/bg light', 4.5],
    ['#0e7c8c', '#faf9f6', 'primary/bg light', 4.5],
    // ... add all pairs
  ];
  let allPass = true;
  for (const [fg, bg, label, threshold] of pairs) {
    const ratio = contrast(fg, bg);
    const pass = ratio >= threshold;
    if (!pass) allPass = false;
    console.log(pass ? 'PASS' : 'FAIL', ratio.toFixed(2) + ':1', label);
  }
  process.exit(allPass ? 0 : 1);
  "
  ```

  Additionally, verify no hardcoded color hex values leaked outside :root and [data-theme="dark"] blocks.
  </verify>
  <done>Every text-on-background color token pair passes WCAG AA contrast (4.5:1 normal text, 3:1 large text/UI) in both light and dark modes. Text-level tokens either serve distinct purposes or are consolidated. Gold accent usage is appropriate. Dark mode remains navy-based.</done>
</task>

<task type="auto">
  <name>Task 2: Verify dark mode surface layering and inverse section cohesion</name>
  <files>css/main.css</files>
  <action>
  After token contrast fixes from Task 1, verify the dark mode visual system as a coherent whole:

  **Surface elevation check:**
  Verify that the 3-tier dark background system creates visible but subtle layering:
  - --color-background (#1a2838) — page background (deepest)
  - --color-background-alt (#243447) — alternating sections (mid)
  - --color-surface (#2a3f54) — cards, elevated panels (lightest)

  Each tier should be visibly distinct from its neighbors. If Task 1 adjusted any of these, verify the progression still works. The visual contrast between tiers should be enough to see the elevation but not so much that the palette feels fragmented.

  **Inverse section cohesion in dark mode:**
  In light mode, inverse sections (nav, hero, footer) use --color-inverse (#1a2838) as background, which is the same as dark mode's --color-background. Evaluate whether these sections need different treatment in dark mode to remain visually distinct from the regular page background. The current approach uses --color-surface for the dark mode footer override (line ~150 of main.css). Check if this pattern should extend to other inverse sections or if the current handling is sufficient.

  **Check existing inverse-text tokens on dark backgrounds:**
  - --color-inverse-text-muted and --color-inverse-text-light are used for muted text on dark sections (nav, hero, footer)
  - These should still pass contrast after any dark mode background adjustments from Task 1
  - Verify all usages in the CSS and confirm each pairing still works

  **Update comments** in the dark mode section documenting the surface elevation strategy and any decisions made about inverse sections.
  </action>
  <verify>
  1. Visually inspect the dark mode background tiers: compute luminance difference between each pair to confirm visible differentiation (minimum 5% luminance difference between tiers).
  2. Verify --color-inverse-text-muted and --color-inverse-text-light still pass contrast on all dark section backgrounds.
  3. CSS parses without errors: `npx stylelint css/main.css --config .stylelintrc.json 2>/dev/null || echo "No stylelint config or lint passed"`
  </verify>
  <done>Dark mode presents a cohesive, navy-based visual identity with clearly differentiated surface tiers. Inverse sections are handled consistently. All inverse-text tokens pass contrast on their respective backgrounds.</done>
</task>

</tasks>

<verification>
1. Run contrast ratio calculator against all text/background token pairs in both modes — 100% WCAG AA pass rate
2. Verify no hardcoded hex values exist outside :root and [data-theme="dark"] blocks
3. Dark mode backgrounds are all navy-based (hue in 200-220 range, not pure gray or black)
4. CSS file parses without syntax errors
</verification>

<success_criteria>
- Every color token pair that represents text-on-background passes WCAG AA contrast
- Dark mode is cohesive, navy-based, with clear surface elevation tiers
- Text-level tokens are either consolidated or documented as serving distinct purposes
- Gold accent and teal primary usage is appropriate and accessible
</success_criteria>

<output>
After completion, create `.planning/phases/11-color-refinement-contrast-verification/11-01-SUMMARY.md`
</output>

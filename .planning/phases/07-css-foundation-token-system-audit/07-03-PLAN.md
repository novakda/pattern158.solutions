---
phase: 07-css-foundation-token-system-audit
plan: 03
type: execute
wave: 3
depends_on:
  - 07-01
  - 07-02
files_modified:
  - .stylelintrc.json
  - package.json
autonomous: true
requirements:
  - CSS-04

must_haves:
  truths:
    - "Running npx stylelint css/main.css reports zero errors (all values use design tokens)"
    - "Stylelint config enforces token usage for colors, font-sizes, and spacing properties"
    - "Stylelint config includes basic code style rules (no duplicate selectors, naming conventions)"
    - "Future hardcoded values added to CSS will be caught by Stylelint"
  artifacts:
    - path: ".stylelintrc.json"
      provides: "Stylelint configuration with token enforcement rules"
      contains: "stylelint-config-standard"
    - path: "package.json"
      provides: "Stylelint dev dependencies"
      contains: "stylelint"
  key_links:
    - from: ".stylelintrc.json"
      to: "css/main.css"
      via: "npx stylelint css/main.css validates token usage"
      pattern: "declaration-property-value-disallowed-list"
---

<objective>
Configure Stylelint with token enforcement rules and validate the migrated CSS passes with zero violations.

Purpose: CSS-04 enforcement -- ensures the token migration from Plans 01-02 stays clean and catches any future hardcoded values. Stylelint rules cover token enforcement AND basic code style (per user decision).

Output: .stylelintrc.json configuration, updated package.json with stylelint dependencies, zero violations on css/main.css.
</objective>

<execution_context>
@/home/xhiris/.claude/get-shit-done/workflows/execute-plan.md
@/home/xhiris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-css-foundation-token-system-audit/07-CONTEXT.md
@.planning/phases/07-css-foundation-token-system-audit/07-RESEARCH.md
@.planning/phases/07-css-foundation-token-system-audit/07-01-SUMMARY.md
@.planning/phases/07-css-foundation-token-system-audit/07-02-SUMMARY.md
@css/main.css
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Stylelint and create configuration</name>
  <files>.stylelintrc.json, package.json</files>
  <action>
Install Stylelint and the standard config:

```bash
npm install --save-dev stylelint stylelint-config-standard
```

Create `.stylelintrc.json` in the project root with these rules:

1. **Extend** stylelint-config-standard for base CSS code quality rules.

2. **Token enforcement rules** using `declaration-property-value-disallowed-list`:
   - `font-size`: Disallow any value that doesn't start with `var(--` -- EXCEPT `0.9em` for code blocks (add to `ignoreValues` or handle via message). Pattern: block values matching `/^\d/` for font-size property.
   - `color`, `background-color`, `border-color`, `outline-color`: Disallow hex values (`/#/`) and named colors. Allow `var(--`, `transparent`, `currentColor`, `inherit`, `none`.
   - `background`: Disallow standalone hex/rgb that aren't part of shorthand with url(). Allow `var(--`, `transparent`, `none`, `url(`.
   - `padding`, `margin`, `gap`: These are harder to enforce because many valid values exist (0, auto, calc). Set as WARNING level initially, not error.

3. **Basic code style rules** (per user decision -- "Rule scope: Token enforcement AND basic style rules"):
   - `no-duplicate-selectors: true` (error)
   - `selector-class-pattern`: Allow kebab-case and page-prefixed patterns (regex: `^[a-z][a-z0-9-]*$`)
   - `declaration-block-no-duplicate-properties: true` (error)
   - `no-descending-specificity: null` (disable -- cascade layers intentionally control this)
   - `font-family-name-quotes: "always-where-recommended"` (warning)

4. **Ignore patterns**:
   - Ignore the :root and [data-theme="dark"] blocks for color rules (these define the tokens themselves)
   - Ignore @layer declarations if stylelint doesn't recognize them (check compatibility)

5. **Severity**: Set token enforcement (font-size, colors) to ERROR level since Plans 01-02 should have migrated everything. Set spacing enforcement to WARNING level since some structural values legitimately remain hardcoded.

Use the `overrides` pattern if needed to handle :root exceptions:
```json
{
  "overrides": [{
    "files": ["css/main.css"],
    "rules": { ... }
  }]
}
```

Also consider using `ignoreProperties` or `ignoreValues` to handle legitimate exceptions (0.9em for code, transparent, currentColor, etc.).
  </action>
  <verify>
Run: cat .stylelintrc.json -- confirms valid JSON with expected rules.
Run: cat package.json -- confirms stylelint and stylelint-config-standard in devDependencies.
Run: npx stylelint --version -- confirms stylelint is installed.
  </verify>
  <done>Stylelint installed with stylelint-config-standard. Configuration file created with token enforcement and code style rules.</done>
</task>

<task type="auto">
  <name>Task 2: Validate CSS and fix any remaining violations</name>
  <files>.stylelintrc.json, css/main.css</files>
  <action>
Run Stylelint against the CSS file:

```bash
npx stylelint css/main.css
```

Analyze the output:
1. **Token enforcement errors** (font-size, color hardcodes): These should be ZERO if Plans 01-02 completed correctly. If any remain, fix them in css/main.css using the appropriate token.

2. **Code style errors** (duplicate selectors, duplicate properties): Fix these in css/main.css.

3. **Spacing warnings** (hardcoded padding/margin values): Review each. If they're structural (0, 0 auto, hamburger dimensions), add to the ignore list in .stylelintrc.json. If they should be tokens, fix in css/main.css.

4. **False positives from @layer syntax**: If stylelint-config-standard doesn't fully support @layer (it should in v16+), add appropriate ignoreAtRules or customSyntax configuration.

5. **:root token definition false positives**: Ensure the rules don't flag the token definitions themselves. Use `ignoreSelectors` or add a comment-based disable for the :root block if needed: `/* stylelint-disable */` around :root.

Iterate until:
- Zero ERRORS from `npx stylelint css/main.css`
- Only expected WARNINGS remain (spacing structural values)

If the Stylelint config needs significant adjustments to avoid false positives, update .stylelintrc.json. Document any exceptions with comments in the config file explaining WHY each exception exists.

Finally, decide on automation approach (per Claude's discretion):
- If the project already uses git hooks: add stylelint to pre-commit
- If no hooks exist: document the manual command in a comment at top of .stylelintrc.json
- Given the zero-build philosophy, a simple `npx stylelint css/main.css` command documented in the config is appropriate
  </action>
  <verify>
Run: npx stylelint css/main.css -- returns zero errors (warnings are acceptable for spacing).
Run: npx stylelint css/main.css --formatter json | grep -c '"severity":"error"' -- returns 0.
Verify .stylelintrc.json is valid JSON: node -e "require('./.stylelintrc.json')"
  </verify>
  <done>Stylelint passes with zero errors on css/main.css. Configuration documented with exception explanations. Token enforcement active for font-size, colors. Spacing at warning level. Future violations will be caught.</done>
</task>

</tasks>

<verification>
1. `npx stylelint css/main.css` produces zero errors
2. `npx stylelint css/main.css 2>&1 | grep -c 'error'` returns 0
3. `.stylelintrc.json` is valid JSON and extends stylelint-config-standard
4. package.json includes stylelint and stylelint-config-standard in devDependencies
5. Adding a test hardcoded font-size (e.g., `font-size: 2rem`) temporarily to CSS and running stylelint catches it as an error
</verification>

<success_criteria>
- Stylelint installed and configured with stylelint-config-standard
- Token enforcement rules active for font-size (error) and colors (error)
- Spacing token enforcement at warning level
- Basic code style rules enabled (no duplicates, naming conventions)
- Zero errors when running npx stylelint css/main.css
- Future hardcoded values will be caught as violations
</success_criteria>

<output>
After completion, create `.planning/phases/07-css-foundation-token-system-audit/07-03-SUMMARY.md`
</output>

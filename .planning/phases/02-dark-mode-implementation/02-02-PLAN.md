---
phase: 02-dark-mode-implementation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - index.html
  - philosophy.html
  - faq.html
  - contact.html
  - testimonials.html
  - exhibits/exhibit-a.html
  - exhibits/exhibit-b.html
  - exhibits/exhibit-c.html
  - exhibits/exhibit-d.html
  - exhibits/exhibit-e.html
  - exhibits/exhibit-f.html
  - exhibits/exhibit-g.html
  - exhibits/exhibit-h.html
  - exhibits/exhibit-i.html
autonomous: false

must_haves:
  truths:
    - "User can toggle between light and dark themes via navigation control"
    - "User's theme preference persists across browser sessions"
    - "Theme automatically respects system preference on first visit"
    - "No flash of unstyled content on any page load in either theme"
    - "Theme toggle is keyboard accessible with correct ARIA states"
  artifacts:
    - path: "index.html"
      provides: "Reference implementation of dark mode HTML integration"
      contains: "data-theme"
    - path: "philosophy.html"
      provides: "Dark mode HTML integration"
      contains: "theme-toggle"
    - path: "faq.html"
      provides: "Dark mode HTML integration"
      contains: "theme-toggle"
    - path: "contact.html"
      provides: "Dark mode HTML integration"
      contains: "theme-toggle"
    - path: "testimonials.html"
      provides: "Dark mode HTML integration"
      contains: "theme-toggle"
    - path: "exhibits/exhibit-a.html"
      provides: "Dark mode HTML integration for exhibit pages"
      contains: "theme-toggle"
  key_links:
    - from: "Inline blocking script in <head>"
      to: "localStorage"
      via: "Synchronous read before CSS loads"
      pattern: "localStorage\\.getItem.*theme"
    - from: "Toggle button click handler"
      to: "data-theme attribute on <html>"
      via: "setAttribute/removeAttribute"
      pattern: "setAttribute.*data-theme"
    - from: "Toggle button click handler"
      to: "localStorage"
      via: "setItem for persistence"
      pattern: "localStorage\\.setItem.*theme"
    - from: "Theme toggle button"
      to: "ARIA state"
      via: "aria-pressed attribute update"
      pattern: "aria-pressed"
---

<objective>
Integrate dark mode into all 14 HTML pages: add the FOUC-preventing inline blocking script, color-scheme meta tag, and accessible theme toggle button with full JavaScript logic.

Purpose: Complete the dark mode implementation by wiring the CSS token system (from Plan 01) to user interaction. The inline blocking script prevents flash of unstyled content by reading localStorage synchronously before CSS loads. The toggle button provides user control with persistence and system preference respect.

Output: All 14 HTML pages with working dark mode toggle, FOUC prevention, and localStorage persistence.
</objective>

<execution_context>
@/home/xhiris/.claude/get-shit-done/workflows/execute-plan.md
@/home/xhiris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dark-mode-implementation/02-RESEARCH.md
@.planning/phases/02-dark-mode-implementation/02-01-SUMMARY.md
@index.html
@exhibits/exhibit-a.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FOUC-preventing blocking script and color-scheme meta to all 14 HTML pages</name>
  <files>
    index.html
    philosophy.html
    faq.html
    contact.html
    testimonials.html
    exhibits/exhibit-a.html
    exhibits/exhibit-b.html
    exhibits/exhibit-c.html
    exhibits/exhibit-d.html
    exhibits/exhibit-e.html
    exhibits/exhibit-f.html
    exhibits/exhibit-g.html
    exhibits/exhibit-h.html
    exhibits/exhibit-i.html
  </files>
  <action>
In each of the 14 HTML files, add two elements to the `<head>` section. These MUST appear BEFORE the `<link rel="stylesheet" href="/css/main.css">` tag.

1. Add `<meta name="color-scheme" content="dark light">` after the viewport meta tag.

2. Add the inline blocking script AFTER the color-scheme meta and BEFORE the stylesheet link.

The blocking script (identical for all pages):

```html
<meta name="color-scheme" content="dark light">

<!-- Theme detection: MUST run before CSS to prevent flash -->
<script>
(function() {
    var STORAGE_KEY = 'theme';
    var THEME_ATTR = 'data-theme';
    var prefersDarkQuery = '(prefers-color-scheme: dark)';
    var mql = window.matchMedia(prefersDarkQuery);
    var supportsColorScheme = mql.media === prefersDarkQuery;
    var savedTheme = null;
    try { savedTheme = localStorage.getItem(STORAGE_KEY); } catch (e) {}
    if (savedTheme === 'dark') {
        document.documentElement.setAttribute(THEME_ATTR, 'dark');
    } else if (savedTheme === null && supportsColorScheme && mql.matches) {
        document.documentElement.setAttribute(THEME_ATTR, 'dark');
    }
})();
</script>
```

The resulting `<head>` structure for each page should be:
```
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="dark light">
<!-- Theme detection script -->
<script>...</script>
<link rel="preconnect" ...>
<link rel="preconnect" ...>
<link href="https://fonts.googleapis.com/..." rel="stylesheet">
<link rel="stylesheet" href="/css/main.css">
...
```

The script placement is CRITICAL -- it must execute synchronously before any stylesheet is parsed. This is what prevents FOUC.

Apply this identical modification to all 14 files. The script content is the same regardless of whether the page is a root page or an exhibit page (it references no relative paths).
  </action>
  <verify>
For each of the 14 HTML files:
- `grep "color-scheme" {file}` returns a match
- `grep "STORAGE_KEY" {file}` returns a match (inline script present)
- Verify script appears BEFORE `<link rel="stylesheet"` in the file (script line number < stylesheet line number)

Quick check: `grep -l "color-scheme" *.html exhibits/*.html | wc -l` should return 14.
  </verify>
  <done>
All 14 HTML pages contain the color-scheme meta tag and inline blocking script, positioned before the stylesheet link. Script reads localStorage synchronously and sets data-theme attribute if dark mode is preferred.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add accessible theme toggle button with JS to all 14 HTML navigation sections</name>
  <files>
    index.html
    philosophy.html
    faq.html
    contact.html
    testimonials.html
    exhibits/exhibit-a.html
    exhibits/exhibit-b.html
    exhibits/exhibit-c.html
    exhibits/exhibit-d.html
    exhibits/exhibit-e.html
    exhibits/exhibit-f.html
    exhibits/exhibit-g.html
    exhibits/exhibit-h.html
    exhibits/exhibit-i.html
  </files>
  <action>
In each of the 14 HTML files, add the theme toggle button as the LAST `<li>` in the `<nav> <ul>` element. The button includes inline SVG icons for sun (dark mode active) and moon (light mode active).

Add this `<li>` as the last item in the navigation `<ul>`:

```html
<li>
    <button id="theme-toggle" class="theme-toggle" type="button"
            aria-label="Toggle dark mode" aria-pressed="false">
        <svg class="icon-sun" aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
        <svg class="icon-moon" aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
        <span class="sr-only">Toggle dark mode</span>
    </button>
</li>
```

Then, add the toggle JavaScript as a `<script>` tag just before the closing `</body>` tag of each page. This script handles click toggling, ARIA state, localStorage persistence, cross-tab synchronization, and system preference change listening:

```html
<script>
(function() {
    var STORAGE_KEY = 'theme';
    var THEME_ATTR = 'data-theme';
    var toggle = document.getElementById('theme-toggle');
    if (!toggle) return;

    // Set initial ARIA state based on current theme
    var isDark = document.documentElement.getAttribute(THEME_ATTR) === 'dark';
    toggle.setAttribute('aria-pressed', isDark ? 'true' : 'false');

    // Toggle handler
    toggle.addEventListener('click', function() {
        var html = document.documentElement;
        var currentlyDark = html.getAttribute(THEME_ATTR) === 'dark';
        var newTheme = currentlyDark ? 'light' : 'dark';

        if (newTheme === 'dark') {
            html.setAttribute(THEME_ATTR, 'dark');
        } else {
            html.removeAttribute(THEME_ATTR);
        }

        toggle.setAttribute('aria-pressed', newTheme === 'dark' ? 'true' : 'false');

        try { localStorage.setItem(STORAGE_KEY, newTheme); } catch (e) {}
    });

    // Cross-tab synchronization
    window.addEventListener('storage', function(e) {
        if (e.key === STORAGE_KEY) {
            var html = document.documentElement;
            if (e.newValue === 'dark') {
                html.setAttribute(THEME_ATTR, 'dark');
                toggle.setAttribute('aria-pressed', 'true');
            } else {
                html.removeAttribute(THEME_ATTR);
                toggle.setAttribute('aria-pressed', 'false');
            }
        }
    });

    // System preference change listener (respects manual override)
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
        try {
            if (localStorage.getItem(STORAGE_KEY) !== null) return;
        } catch (err) {}
        var html = document.documentElement;
        if (e.matches) {
            html.setAttribute(THEME_ATTR, 'dark');
            toggle.setAttribute('aria-pressed', 'true');
        } else {
            html.removeAttribute(THEME_ATTR);
            toggle.setAttribute('aria-pressed', 'false');
        }
    });
})();
</script>
```

Apply both modifications (nav button + body script) identically to all 14 HTML files. The content is the same across root pages and exhibit pages -- no path-relative references.

Important: The toggle button `<li>` goes INSIDE the existing `<ul>` as the last list item. Do NOT create a separate element outside the `<ul>`.
  </action>
  <verify>
For each of the 14 HTML files:
- `grep "theme-toggle" {file}` returns matches (button in nav + script)
- `grep "aria-pressed" {file}` returns matches (ARIA state management)
- `grep "icon-sun" {file}` returns a match (sun SVG icon)
- `grep "icon-moon" {file}` returns a match (moon SVG icon)

Quick check: `grep -l "theme-toggle" *.html exhibits/*.html | wc -l` should return 14.
Quick check: `grep -l "addEventListener.*storage" *.html exhibits/*.html | wc -l` should return 14.
  </verify>
  <done>
All 14 HTML pages contain: (1) theme toggle button in navigation with sun/moon SVG icons and proper ARIA attributes, (2) toggle JavaScript before closing body tag with click handler, localStorage persistence, cross-tab sync, and system preference listener.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual and functional verification of dark mode across all page types</name>
  <action>
Human verifies the complete dark mode implementation works correctly across all page types. This checkpoint covers visual appearance, functional behavior, persistence, and accessibility.

What was built:
- CSS dark theme tokens with brand-aligned navy palette
- Theme toggle button in navigation (sun/moon icons)
- FOUC-preventing inline blocking script
- localStorage persistence
- System preference detection
- Cross-tab synchronization

How to verify:
1. Open index.html in browser. Page should load in light mode (default).
2. Click the moon icon in the top-right navigation area. Page should instantly switch to dark mode with navy (#1a2838) background, light text, and teal accents preserved.
3. The icon should now show a sun. Click it again to return to light mode.
4. While in dark mode, refresh the page. It should load directly in dark mode with NO flash of light content.
5. Open a second tab with any other page (e.g., philosophy.html). It should also be in dark mode (localStorage shared).
6. Toggle theme in the second tab. Check if the first tab updates when you focus it (cross-tab sync).
7. Verify these pages in dark mode look correct:
   - index.html (hero section, project cards, specialty cards)
   - philosophy.html (content sections)
   - faq.html (accordion items)
   - testimonials.html (field report cards)
   - exhibits/exhibit-a.html (exhibit detail page)
8. Check the navigation bar: it should remain dark in both themes.
9. Check the footer: it should remain dark in both themes.
10. Keyboard test: Tab to the toggle button, press Enter/Space to toggle theme.
  </action>
  <verify>User confirms all 10 verification steps pass.</verify>
  <done>User types "approved" or describes issues for remediation.</done>
</task>

</tasks>

<verification>
1. All 14 HTML pages have inline blocking script in `<head>` before stylesheet
2. All 14 HTML pages have `<meta name="color-scheme" content="dark light">`
3. All 14 HTML pages have theme toggle button in navigation
4. All 14 HTML pages have toggle JavaScript before `</body>`
5. Theme persists across page navigation and browser sessions
6. No FOUC on any page in either theme
7. Dark mode uses navy palette, not generic black
8. Nav and footer maintain correct appearance in both themes
9. Toggle button is keyboard accessible with correct ARIA states
</verification>

<success_criteria>
- User can toggle between light and dark themes on any of the 14 pages
- Dark theme uses brand-aligned navy palette maintaining NTSB aesthetic
- Theme preference persists across browser sessions (localStorage)
- System preference (prefers-color-scheme) respected on first visit
- Zero FOUC on any page load in either theme
- Toggle button accessible via keyboard with aria-pressed state
- Cross-tab theme synchronization works
</success_criteria>

<output>
After completion, create `.planning/phases/02-dark-mode-implementation/02-02-SUMMARY.md`
</output>
